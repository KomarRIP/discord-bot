## Repair / Reconciliation (эксплуатационные сценарии)

Цель: дать безопасные инструменты для восстановления, когда Discord‑состояние или `discord_mappings` разъехались:

- бот перезапустился в середине деплоя,
- были ручные изменения ролей/каналов,
- часть объектов удалили,
- появились дубликаты (например, из-за потери mapping до записи).

Документ описывает **сценарии и правила**, а не реализацию.

---

## 1. Основные команды (план)

### 1.1. `/deploy repair` (безопасное восстановление)

Действия:
- пересобрать desired state из активного шаблона + unit config;
- выполнить **reconciliation**:
  - восстановить mapping через adoption (managed names),
  - создать отсутствующие объекты,
  - обновить fingerprint’ы и overwrites (replace),
  - зафиксировать шаги как новый deployment.

Гарантия: не удаляет объекты по умолчанию.

### 1.2. `/deploy diagnose` (диагностика без изменений)

Возвращает отчёт:
- отсутствующие mapping’и (ожидаются, но нет записи),
- dangling mapping’и (в БД есть, в Discord объекта нет),
- дубликаты managed objects (по ключу),
- «осиротевшие» объекты (похожи на managed, но key не распознан),
- риск lockout по политикам.

### 1.3. `/deploy adopt` (точечное усыновление)

Используется, если пользователь вручную перенёс/переименовал объект и нужно связать его с ключом:
- `key` + `discordId` -> записать mapping (с проверками).

Ограничение: доступно только владельцу guild или SYS_BOT_ADMIN.

### 1.4. `/deploy prune` (опасная операция, фаза 2)

Удаление дубликатов/осиротевших объектов — только с явным подтверждением и только после dry-run.

---

## 2. Reconciliation алгоритм (высокий уровень)

Вход: `guildId`, валидированный `DesiredState`, текущие `discord_mappings`.

### 2.1. Восстановление mapping’ов (adoption pass)

Для каждого `DesiredObject` (role/category/channel/message):

1) если mapping есть:
   - проверить существование объекта по `discordId`
   - если не найден → пометить mapping как dangling (для отчёта) и продолжить
2) если mapping нет или dangling:
   - попытаться найти объект по **managedName** (см. `rate-limit-and-retry.md`)
   - если найден ровно один → **adopt**: создать/обновить mapping
   - если найдено 0 → требуется create на этапе apply
   - если найдено >1 → конфликт, выдать отчёт и остановить repair (чтобы не привязать ошибочно)

### 2.2. Приведение к целевому состоянию (ensure pass)

После adoption:

- `ensure` роли (создать/обновить)
- `ensure` категории, затем каналы (с parent)
- `setPermissionOverwrites replace`
- `ensureMessage` системные сообщения

Каждый шаг журналируется в `deployment_steps`.

---

## 3. Детектор дублей (duplicate detector)

### 3.1. Что считаем дублем

- два или более объектов одного типа с одинаковым `〔<Key>〕` в имени;
- либо managed name совпадает полностью;
- либо `discord_mappings` пытается указать на один `discordId` из разных `key`.

### 3.2. Поведение в MVP

- `diagnose` — только отчёт
- `repair` — останавливается при дублях по ключу (требуется ручное вмешательство), чтобы не «закрепить» неверный объект

Причина: лучше остановиться, чем разрушить структуру.

---

## 4. Поведение при ручных изменениях пользователей

### 4.1. Переименование managed объектов

Если пользователь переименовал роль/канал:
- mapping по `discordId` сохранится, деплой обновит имя обратно (если fingerprint учитывает имя).
- если mapping потерян — adoption может не найти объект (имя уже не managed).

Рекомендация MVP:
- предупреждать в правилах: «не переименовывайте элементы с ключами `〔...〕`».

Фаза 2:
- добавить `/deploy adopt` как штатный инструмент восстановления.

### 4.2. Удаление managed объектов

Если объект удалили:
- mapping станет dangling,
- следующий деплой создаст заново и обновит mapping.

---

## 5. Инварианты безопасности repair

- repair не должен:
  - менять права так, чтобы владелец потерял доступ (safety check обязателен),
  - удалять объекты без явного режима prune,
  - автоматически «выбирать» один из дублей.

