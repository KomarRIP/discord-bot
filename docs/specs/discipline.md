## Discipline (дисциплина): записи, severity, аудит, отчётность

Цель: обеспечить единый дисциплинарный контур:

- любые замечания/предупреждения фиксируются прозрачно и неизменяемо,
- доступ к внесению записей ограничен,
- есть единый audit trail,
- поддерживается базовая отчётность.

Связанные документы:
- `docs/core.md` — сущность `DisciplineRecord` (append-only)
- `docs/specs/storage-schema-and-migrations.md` — `discipline_records`, `audit_events`
- `docs/specs/member-role-management.md` — авторизация и события

---

## 1. Типы записей (MVP)

В MVP поддерживаем минимум:

- `note` — замечание (низкая серьёзность)
- `warning` — предупреждение

Фаза 2 (план):
- `penalty` — взыскание (с последствиями)
- `revocation` — аннулирование предыдущей записи (не удаление)

---

## 2. Severity (уровень серьёзности)

MVP:
- `severity` — целое число 1..5 (где 1 — мягко, 5 — критично)

Рекомендации:
- `note`: 1..2
- `warning`: 2..4

Фаза 2:
- привязка severity к автоматическим эскалациям (например, ограничения доступа).

---

## 3. Команды (контракты)

### 3.1. `DisciplineAdd(targetUserId, kind, severity, reason, expiresAt?)`

Инварианты:
- `reason` обязателен
- запись **не редактируется** после создания

Эффекты:
- добавить запись в `discipline_records`
- сгенерировать audit‑событие `DisciplineRecordAdded`
- опубликовать краткую запись в `CH_AUDIT` (если configured)

### 3.2. `DisciplineList(targetUserId, limit=20)`

Возвращает последние записи + агрегаты:
- количество active warnings за период (если есть expiresAt)
- последние причины

### 3.3. `DisciplineRevoke(recordId, reason)`

MVP: опционально (можно отложить), но если делаем:
- не удаляем запись
- создаём новую запись `kind=revocation` или отдельную таблицу «actions» (фаза 2)

---

## 4. Авторизация (MVP)

Кто может создавать дисциплинарные записи:

- `BASE_STAFF`, `BASE_COMMAND`, ownerId

Дополнительный guardrail:
- staff не может создавать записи о command (фаза 2, если потребуется), иначе возможны злоупотребления.

---

## 5. Срок действия и «активные» предупреждения

MVP:
- `expiresAt` поддерживаем как nullable.
- если `expiresAt` задан и прошёл — запись считается неактивной (для агрегатов), но остаётся в истории.

Фаза 2:
- автоматическое снятие «активности» без удаления (просто по времени),
- отчёт «кто на грани эскалации».

---

## 6. Аудит и прозрачность

### 6.1. Обязательные поля audit

- `guildId`
- `actorUserId`
- `targetUserId`
- `recordId`
- `kind`, `severity`
- `reason`
- `createdAt`, `expiresAt`

### 6.2. События

- `DisciplineRecordAdded`
- `DisciplineRecordRevoked` (если реализуем revoke)

---

## 7. Хранение и ретеншн

### 7.1. Хранение

Схема `discipline_records` — в `docs/specs/storage-schema-and-migrations.md`.

### 7.2. Ретеншн (MVP)

Ничего не удаляем автоматически.

Фаза 3:
- ретеншн по политике подразделения (например, удалять notes старше N месяцев), но только после отдельного решения.

