## Discord: требуемые Intents/Permissions и безопасная установка

Цель: чтобы бот мог развернуть структуру и управлять процессами без `Forbidden`, а администратор понимал, какие права нужны и почему.

---

## 1. Требуемые Discord OAuth2 scopes

Для инвайта бота:

- `bot`
- `applications.commands`

---

## 2. Рекомендуемые permissions для роли бота (MVP)

Минимально необходимое для деплоя шаблона:

- **Manage Roles** — создавать/выдавать роли (кроме ролей выше роли бота)
- **Manage Channels** — создавать категории/каналы, менять настройки
- **View Channels** — чтобы видеть/управлять
- **Send Messages** / **Embed Links** — для инструкций, preview, карточек заявок
- **Read Message History** — для обновления/редактирования сообщений
- **Manage Messages** — опционально (закрепление/cleanup), можно отложить

Важно:
- бот не сможет выдавать/снимать роли, которые **выше** его роли в иерархии.
  Требование: роль бота должна быть выше всех управляемых ролей шаблона.

---

## 3. Gateway Intents (MVP)

В зависимости от реализации:

- `Guilds` — обязательно
- `GuildMembers` — если требуется реагировать на вступление/проверять роли участников

MVP рекомендация:
- включить `GuildMembers`, если планируются команды управления ролями (`/roles ...`) и проверка membership.

Если intents ограничены, часть функций можно реализовать через REST по запросу, но UX ухудшится.

---

## 4. Безопасность и anti-lockout

### 4.1. Safety net правила

- перед заменой overwrites в приватных категориях проверяем:
  - ownerId имеет доступ к минимуму критичных каналов, либо
  - есть admin‑роль для управления ботом (`SYS_BOT_ADMIN`) с доступом.

Связано с `docs/specs/deployment.md` и `preview-and-diff.md`.

### 4.2. Рекомендации администратору сервера

- не поднимать управляемые роли выше роли бота
- не переименовывать управляемые объекты с ключами `〔...〕` (иначе adoption может не сработать)

---

## 5. Проверка готовности (preflight)

MVP‑идея (контракт):

Команда `/deploy preview` должна выполнять preflight:
- бот имеет `ManageRoles/ManageChannels`
- роль бота достаточно высоко
- доступен `CH_AUDIT` или есть возможность создать `CAT_LOGS/CH_AUDIT`

При провале — `FORBIDDEN` или `VALIDATION_FAILED` с конкретными инструкциями.

