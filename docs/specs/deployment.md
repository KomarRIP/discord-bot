## Идемпотентный деплой (TemplateDeploymentService)

Цель: превратить `TemplateConfig + UnitConfig` в **целевое состояние** Discord‑сервера без дубликатов и с безопасным retry.

---

## 1. Термины

- **Desired state**: набор сущностей, которые должны существовать (roles/channels/categories/messages) и их настройки.
- **Current state**: то, что реально есть в Discord + what we know из `discord_mappings`.
- **Plan**: упорядоченный список шагов `create/update/skip` с причинами.
- **Fingerprint**: хеш/отпечаток «значимых» полей сущности, используемый для решения, надо ли обновлять объект.

---

## 2. Вход/выход use‑case

### Вход

- `guildId`
- `templateId`
- `unitConfig` (ответы wizard)
- `actor` (кто запустил деплой)

### Выход

- `DeploymentResult`:
  - `deploymentId`
  - `status` (completed/failed)
  - `summary` (created/updated/skipped counts)
  - `errors` (если есть)

---

## 3. Алгоритм (высокоуровнево)

### 3.1. Валидация (до любых Discord операций)

1) загрузить шаблон и проверить `schemaVersion`  
2) проверить ссылки:
- `parentKey` каналов
- `policyKey` для каналов/категорий
- существование `RoleKey`/`ChannelKey` в нужных местах  
3) собрать `DesiredState`:
- роли из `template.roles`
- категории/каналы из `template.channels`
- системные сообщения (правила/инструкции) — по правилам шаблона  
4) скомпилировать permissions:
- для каждого канала/категории вычислить конкретные overwrites (через PermissionCompiler)

Если что‑то невалидно — **падаем до начала**.

### 3.2. Планирование (diff)

1) загрузить `discord_mappings` по `guildId`  
2) для каждой сущности desired:
- если есть mapping: попытаться «прочитать» объект по discordId
  - если объект отсутствует → план `create` (и позже обновить mapping)
  - если объект есть → сравнить fingerprint → `update` или `skip`
- если mapping отсутствует → план `create`
3) планируем шаги в безопасном порядке:
- roles
- categories
- channels (с учётом parent)
- overwrites (категории, затем каналы)
- системные сообщения (последними)

### 3.3. Применение (apply)

Все шаги выполняются через **очередь Discord API** (rate‑limit/backoff).

Правило устойчивости:
- после каждого успешного шага фиксируем progress + mapping fingerprint (если применимо);
- при падении можно безопасно повторить `apply` — план пересоберётся и пропустит уже применённое.

---

## 4. Fingerprint: что учитываем

### 4.1. Канонизация перед хешированием

- строки: trim, нормализация пробелов (без изменения смысла)
- массивы: сортируем, если порядок незначим (например, overwrites)
- числа: приводим к int/enum

### 4.2. Role fingerprint (MVP)

Включает:
- `name`
- `color` (если используется)
- `hoist`
- `mentionable`
- `permissions` (если роль несёт permissions)
- **не включаем**: `position` (позиции в Discord нестабильны и часто требуют отдельной логики)

Позиционирование ролей (order) — отдельная задача фазы 2: «упорядочивание без ломания».

### 4.3. Channel/Category fingerprint

- `name`
- `type`
- `topic` (для text)
- `parentKey` (логическая привязка)
- `policyKey` (как указание на целевую модель overwrites)

Фактические overwrites считаются отдельно, но при наличии `policyKey` мы можем обновлять overwrites всегда, либо сравнивать их fingerprint отдельно.

### 4.4. Overwrites fingerprint

Хешируем нормализованный список:
- `(principalType, principalKeyOrEveryone, allowBits, denyBits)`

Где `principalKeyOrEveryone` — `@everyone` или `RoleKey`, разрешённые шаблоном.

---

## 5. Safety checks (защита от блокировки сервера)

Перед применением «закрывающих» политик проверяем:

- у **владельца guild** (ownerId) остаётся доступ к критичным зонам, либо
- есть «бот‑админ роль» (конфиг) с доступом.

Если проверка не проходит — деплой отклоняется с явной ошибкой.

---

## 6. Политика удаления и «осиротевшие» объекты

В MVP:

- по умолчанию **не удаляем** роли/каналы, даже если они отсутствуют в шаблоне;
- обнаруженные «лишние» объекты помечаем в `DeploymentResult` как `orphaned` (только отчёт).

Опционально (фаза 2): режим `prune` с явным подтверждением.

---

## 7. Обработка ошибок и retry

Классы ошибок:

- `ValidationError`: нет retry (исправляем конфиг/ввод)
- `Forbidden`: нет retry, требуется настройка прав бота
- `RateLimited/Transient`: retry по backoff через очередь
- `Conflict`: пересобрать план (состояние изменилось)

Рекомендация: общий «budget» на деплой — например 10 минут; далее — `failed` с возможностью продолжить позже.

