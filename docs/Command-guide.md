# Руководство по командам Discord бота

**Версия:** 1.0 (MVP)  
**Последнее обновление:** 2024-12-20

Этот документ описывает все доступные команды Discord бота для милсим подразделений Arma 3 в стиле ССО РФ.

---

## Содержание

1. [Команды настройки](#команды-настройки)
2. [Команды деплоя](#команды-деплоя)
3. [Команды приёмной (Intake)](#команды-приёмной-intake)
4. [Команды управления ролями](#команды-управления-ролями)
5. [Авторизация и права доступа](#авторизация-и-права-доступа)

---

## Команды настройки

### `/setup start`

**Описание:** Запускает мастер настройки бота для нового сервера.

**Требования:** Только владелец сервера или администратор бота

**Использование:** Первая команда, которую нужно выполнить на сервере. Мастер поможет настроить:
- Шаблон структуры (SSO_RF)
- Название подразделения
- Размер подразделения
- Режим приёмной
- Политику для гостей

**Результат:** Создаётся сессия мастера настройки с интерактивным интерфейсом.

---

### `/setup status`

**Описание:** Показывает текущий статус мастера настройки.

**Требования:** Только владелец сервера или администратор бота

**Использование:** Используйте для проверки прогресса настройки или возобновления сессии.

---

### `/setup cancel`

**Описание:** Отменяет текущую сессию мастера настройки.

**Требования:** Только владелец сервера или администратор бота

**Использование:** Используйте, если хотите начать настройку заново.

---

## Команды деплоя

### `/deploy preview`

**Описание:** Показывает план изменений перед применением шаблона.

**Требования:** Только владелец сервера или администратор бота

**Использование:** 
```
/deploy preview
```

**Результат:** Показывает список операций, которые будут выполнены:
- Создание новых ролей
- Создание новых каналов
- Обновление существующих объектов
- Настройка прав доступа

**Безопасность:** Эта команда только показывает изменения, не применяет их.

---

### `/deploy apply`

**Описание:** Применяет шаблон структуры к серверу.

**Требования:** Только владелец сервера или администратор бота

**Использование:**
```
/deploy apply
```

**Результат:** 
- Создаются роли, каналы и категории согласно шаблону
- Настраиваются права доступа
- Обновляются mappings для отслеживания объектов

**Важно:** Деплой идемпотентен — можно запускать несколько раз безопасно.

---

## Команды приёмной (Intake)

### `/intake apply`

**Описание:** Подать заявку на вступление в подразделение.

**Требования:** Роль `BASE_GUEST` (Гость)

**Использование:**
```
/intake apply
```

**Результат:** Открывается модальное окно с полями для заполнения:
- **Позывной** (2-50 символов)
- **Возраст** (14-100)
- **Часовой пояс**
- **Доступность** (когда можете участвовать)
- **Опыт в Arma**
- **Опыт в милсиме**

После заполнения заявка создаётся в статусе "черновик". Используйте кнопку в сообщении для подачи на рассмотрение.

---

### `/intake list`

**Описание:** Показать список заявок на вступление.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `status` (опционально) — фильтр по статусу:
  - `submitted` — поданные
  - `under_review` — в рассмотрении
  - `approved` — одобренные
  - `rejected` — отклонённые

**Использование:**
```
/intake list
/intake list status:submitted
```

---

### `/intake approve`

**Описание:** Одобрить заявку на вступление.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `id` (обязательно) — ID заявки
- `reason` (опционально) — причина одобрения

**Использование:**
```
/intake approve id:01ARZ3NDEKTSV4RRFFQ69G5FAV reason:Прошел собеседование
```

**Результат:**
- Заявка переводится в статус "одобрена"
- Пользователю автоматически выдаётся роль `BASE_MEMBER`
- Роль `BASE_GUEST` снимается (если была)
- Событие публикуется в канал аудита

---

### `/intake reject`

**Описание:** Отклонить заявку на вступление.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `id` (обязательно) — ID заявки
- `reason` (обязательно) — причина отклонения (минимум 3 символа)

**Использование:**
```
/intake reject id:01ARZ3NDEKTSV4RRFFQ69G5FAV reason:Не подходит по возрасту
```

**Результат:**
- Заявка переводится в статус "отклонена"
- Событие публикуется в канал аудита

---

### `/intake cancel`

**Описание:** Отменить свою заявку на вступление.

**Требования:** Автор заявки (любой пользователь может отменить только свою заявку)

**Использование:**
```
/intake cancel
```

**Результат:** Активная заявка отменяется.

---

## Команды управления ролями

### `/roles set-rank`

**Описание:** Установить звание участнику.

**Требования:** Роль `BASE_COMMAND` или владелец сервера

**Параметры:**
- `user` (обязательно) — участник, которому устанавливается звание
- `rank` (обязательно) — звание (autocomplete доступен, можно выбрать "Снять звание")

**Использование:**
```
/roles set-rank user:@Участник rank:Рядовой
/roles set-rank user:@Участник rank:— Снять звание —
```

**Ограничения:**
- У участника может быть только одно звание одновременно
- При установке нового звания старое автоматически снимается

**Результат:**
- Звание устанавливается/снимается в Discord
- Обновляется профиль участника в базе данных
- Событие публикуется в канал аудита

---

### `/roles add-position`

**Описание:** Добавить должность участнику.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `user` (обязательно) — участник
- `position` (обязательно) — должность (autocomplete доступен)

**Использование:**
```
/roles add-position user:@Участник position:Командир отделения
```

**Ограничения:**
- Максимум 2 должности у одного участника
- Если должность уже есть, операция будет пропущена (идемпотентность)

**Результат:**
- Должность добавляется в Discord
- Обновляется профиль участника
- Событие публикуется в канал аудита

---

### `/roles remove-position`

**Описание:** Снять должность с участника.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `user` (обязательно) — участник
- `position` (обязательно) — должность для снятия (autocomplete доступен)

**Использование:**
```
/roles remove-position user:@Участник position:Командир отделения
```

**Результат:**
- Должность снимается в Discord
- Обновляется профиль участника
- Событие публикуется в канал аудита

---

### `/roles grant-clearance`

**Описание:** Выдать допуск участнику.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `user` (обязательно) — участник
- `clearance` (обязательно) — допуск (autocomplete доступен)

**Использование:**
```
/roles grant-clearance user:@Участник clearance:Секрет
```

**Ограничения:**
- Если допуск уже есть, операция будет пропущена (идемпотентность)
- Нет ограничений на количество допусков

**Результат:**
- Допуск выдаётся в Discord
- Обновляется профиль участника
- Событие публикуется в канал аудита

---

### `/roles revoke-clearance`

**Описание:** Отозвать допуск у участника.

**Требования:** Роль `BASE_STAFF` или `BASE_COMMAND`

**Параметры:**
- `user` (обязательно) — участник
- `clearance` (обязательно) — допуск для отзыва (autocomplete доступен)

**Использование:**
```
/roles revoke-clearance user:@Участник clearance:Секрет
```

**Результат:**
- Допуск отзывается в Discord
- Обновляется профиль участника
- Событие публикуется в канал аудита

---

### `/roles profile`

**Описание:** Показать профиль участника с его ролями.

**Требования:** Любой пользователь (просмотр профилей доступен всем)

**Параметры:**
- `user` (обязательно) — участник

**Использование:**
```
/roles profile user:@Участник
```

**Результат:** Показывает информацию о участнике:
- Текущее звание (rank)
- Должности (positions)
- Допуски (clearances)

---

## Авторизация и права доступа

### Роли и их права

#### `BASE_GUEST` (Гость)
- ✅ Подавать заявки на вступление (`/intake apply`)
- ✅ Отменять свои заявки (`/intake cancel`)
- ✅ Просматривать профили участников (`/roles profile`)

#### `BASE_STAFF` (Персонал)
- ✅ Все права `BASE_GUEST`
- ✅ Просматривать список заявок (`/intake list`)
- ✅ Одобрять/отклонять заявки (`/intake approve`, `/intake reject`)
- ✅ Добавлять/снимать должности (`/roles add-position`, `/roles remove-position`)
- ✅ Выдавать/отзывать допуски (`/roles grant-clearance`, `/roles revoke-clearance`)
- ❌ Устанавливать звания (требуется `BASE_COMMAND`)

#### `BASE_COMMAND` (Командование)
- ✅ Все права `BASE_STAFF`
- ✅ Устанавливать звания (`/roles set-rank`)

#### Владелец сервера
- ✅ Все права (safety override)
- ✅ Настройка бота (`/setup`)
- ✅ Деплой шаблонов (`/deploy`)

### Примечания по безопасности

1. **Идемпотентность:** Все операции с ролями идемпотентны — повторное выполнение безопасно.

2. **Валидация:** 
   - Проверяется существование роли в шаблоне
   - Проверяется тип роли (rank/position/clearance)
   - Проверяются инварианты (максимум 1 rank, максимум 2 positions)

3. **Audit Log:** Все изменения ролей и заявок логируются в базу данных и публикуются в канал аудита (`CH_AUDIT`).

4. **Graceful Degradation:** Если канал аудита не настроен, события всё равно сохраняются в БД, но не публикуются в Discord.

---

## Каналы и автоматизация

### Автоматические каналы

После деплоя шаблона создаются следующие каналы:

- **`CH_INTAKE_QUEUE`** — очередь заявок на вступление
  - Автоматически публикуются новые заявки
  - Обновляются статусы заявок в реальном времени
  - Содержит кнопки для одобрения/отклонения

- **`CH_AUDIT`** — канал аудита
  - Публикуются все важные события:
    - Подача заявок
    - Одобрение/отклонение заявок
    - Изменение ролей участников
    - Дисциплинарные записи (в разработке)

---

## Часто задаваемые вопросы

**Q: Как начать использование бота на новом сервере?**  
A: Выполните `/setup start` и следуйте инструкциям мастера настройки.

**Q: Что делать, если роли не отображаются в autocomplete?**  
A: Убедитесь, что деплой шаблона выполнен (`/deploy apply`). Autocomplete показывает только роли из активного шаблона.

**Q: Можно ли изменить звание участнику, если у него уже есть звание?**  
A: Да, при установке нового звания старое автоматически снимается.

**Q: Почему не могу добавить третью должность участнику?**  
A: По умолчанию установлен лимит в 2 должности на участника. Это можно настроить в мастере настройки.

**Q: Где можно посмотреть историю изменений ролей?**  
A: В канале `CH_AUDIT` публикуются все события изменения ролей.

---

## Поддержка

При возникновении проблем:
1. Проверьте, что у вас есть необходимые права доступа
2. Убедитесь, что деплой шаблона выполнен
3. Проверьте канал аудита на наличие ошибок

---

**Примечание:** Этот документ актуален для MVP версии бота. Некоторые функции могут быть расширены в будущих версиях.


